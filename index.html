<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Planner</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="data.js"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: 'VT323', monospace;
            background-color: #2d2b55;
            background-image: radial-gradient(#4a4e69 1px, transparent 1px);
            background-size: 20px 20px;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d2b55; }
        ::-webkit-scrollbar-thumb { background: #a5b4fc; border: 2px solid #2d2b55; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 2px solid #000;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.5);
        }

        .btn-pixel {
            box-shadow: 2px 2px 0px #000;
            transition: all 0.1s;
        }
        .btn-pixel:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px #000;
        }

        .cat-header {
            font-family: sans-serif;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #6b7280;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px dashed #cbd5e1;
        }

        .item-cooked {
            color: #9ca3af;
            text-decoration: line-through;
            background-color: rgba(0,0,0,0.05);
        }
        
        .item-cooked img {
            filter: grayscale(100%);
            opacity: 0.5;
        }

        #sidebar {
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #sidebar.open { transform: translateX(0); }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .pop-anim { animation: pop 0.2s ease; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden text-gray-900 relative">

    <div class="relative z-10 w-full h-full max-w-md mx-auto p-4 flex flex-col">
        <header class="flex justify-between items-center mb-6 pt-2">
            <div>
                <h1 class="text-4xl leading-none underline text-white drop-shadow-[2px_2px_0_rgba(0,0,0,1)]">Meal Planner</h1>
            </div>
            <button onclick="toggleSidebar()" class="btn-pixel bg-indigo-500 hover:bg-indigo-600 text-white p-3 border-2 border-black">
                <i data-lucide="cooking-pot" class="w-8 h-8"></i>
            </button>
        </header>

        <main class="glass-panel flex-1 overflow-y-auto p-4 rounded-none">
            <div id="rotation-list" class="space-y-2">
                </div>
        </main>
    </div>

    <aside id="sidebar" class="absolute inset-y-0 right-0 w-full max-w-sm bg-[#f0f9ff] border-l-4 border-black z-50 flex flex-col shadow-2xl">
        <div class="bg-indigo-600 p-4 border-b-4 border-black flex justify-between items-center">
            <h2 class="text-2xl text-white">Meal Repository</h2>
            <button onclick="toggleSidebar()" class="text-white hover:text-indigo-200">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
        </div>

        <div class="p-4 bg-indigo-100 border-b-4 border-indigo-200">
            <label class="block text-lg mb-1">Add New Item</label>
            
            <div class="flex gap-2 mb-2 items-center">
                <button id="icon-cycler" onclick="cycleNewIcon()" class="w-12 h-12 bg-white border-2 border-black flex items-center justify-center flex-shrink-0 cursor-pointer hover:bg-gray-50 active:translate-y-1" title="Click to change icon">
                    <img id="preview-icon" src="" class="w-8 h-8">
                </button>

                <input type="text" id="new-meal-name" placeholder="e.g., Lasagna" 
                    class="flex-1 p-2 border-2 border-black font-sans text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 h-12">
            </div>
            
            <div class="flex flex-wrap gap-2 mb-2" id="category-selector"></div>
            
            <button onclick="addToRepository()" class="btn-pixel w-full bg-green-500 text-white border-2 border-black py-2 text-xl hover:bg-green-600">
                SAVE TO REPO
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 bg-[#fff1f2]">
            <div id="repo-list" class="space-y-4"></div>
        </div>
    </aside>

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm"></div>

    <audio id="sfx-plop" src="assets/sfx/plop.wav"></audio>
    <audio id="sfx-scratch" src="assets/sfx/scratch.mp3"></audio>
    <audio id="sfx-add-rot" src="assets/sfx/add.mp3"></audio>
    <audio id="sfx-delete" src="assets/sfx/delete.wav"></audio>
    <audio id="sfx-success" src="assets/sfx/success.mp3"></audio>

    <script>
        const CATEGORIES = ['Meal', 'Prep', 'Salad', 'Baking', 'Snack'];
        
        let state = {
            repository: [], 
            rotation: []
        };

        let selectedCategory = 'Meal';
        let currentIconIndex = 0; 

        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            lucide.createIcons();
            renderCategoryButtons();
            updateIconPreview(); 
            renderAll();
        });

        // --- Logic ---

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function saveState() {
            localStorage.setItem('mealPlannerState_v2', JSON.stringify(state));
            renderAll();
        }

        function loadState() {
            const saved = localStorage.getItem('mealPlannerState_v2');
            if (saved) {
                state = JSON.parse(saved);
            } else {
                state.repository = [
                    { id: '1', name: 'Spaghetti', category: 'Meal', iconIndex: 0 },
                    { id: '2', name: 'Greek Salad', category: 'Salad', iconIndex: 0 },
                    { id: '3', name: 'Cookies', category: 'Snack', iconIndex: 0 }
                ];
            }
        }

        // --- Audio Logic ---
        function playSfx(type) {
            const audio = document.getElementById('sfx-' + type);
            if (audio) {
                audio.volume = 0.2; // <--- 0.2 = 20% volume. Change to 0.5 for 50%, etc.
                audio.currentTime = 0; 
                audio.play().catch(e => {
                    // console.log("Audio blocked/missing");
                });
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                overlay.classList.remove('hidden');
                playSfx('plop');
            } else {
                overlay.classList.add('hidden');
            }
        }

        // --- Category & Icon Selection ---

        function setCategory(cat) {
            selectedCategory = cat;
            currentIconIndex = 0; 
            renderCategoryButtons();
            updateIconPreview();
            playSfx('plop');
        }

        function cycleNewIcon() {
            currentIconIndex++;
            updateIconPreview();
            const img = document.getElementById('preview-icon');
            img.classList.remove('pop-anim');
            void img.offsetWidth; 
            img.classList.add('pop-anim');
        }

        function updateIconPreview() {
            if(typeof getIconUrl === 'function') {
                const url = getIconUrl(selectedCategory, currentIconIndex);
                document.getElementById('preview-icon').src = url;
            }
        }

        // --- CRUD Repository ---

        function addToRepository() {
            const input = document.getElementById('new-meal-name');
            const name = input.value.trim();
            if (!name) return;

            const newItem = {
                id: generateId(),
                name: name,
                category: selectedCategory,
                iconIndex: currentIconIndex 
            };

            state.repository.push(newItem);
            input.value = ''; 
            currentIconIndex = Math.floor(Math.random() * 5); 
            updateIconPreview();
            
            saveState();
            playSfx('success');
        }

        function deleteFromRepository(id) {
            // No confirm alert, as requested
            state.repository = state.repository.filter(item => item.id !== id);
            saveState();
            playSfx('delete');
        }

        function editRepositoryItem(id) {
            const item = state.repository.find(i => i.id === id);
            const newName = prompt("Edit Meal Name:", item.name);
            if (newName && newName.trim() !== "") {
                item.name = newName.trim();
                saveState();
            }
        }

        // --- CRUD Rotation ---

        function addToRotation(repoId) {
            const repoItem = state.repository.find(item => item.id === repoId);
            if (!repoItem) return;

            state.rotation.push({
                rotId: generateId(),
                repoId: repoItem.id,
                name: repoItem.name,
                category: repoItem.category,
                iconIndex: repoItem.iconIndex || 0, 
                cooked: false
            });
            saveState();
            playSfx('add-rot');
        }

        function removeFromRotation(rotId) {
            state.rotation = state.rotation.filter(item => item.rotId !== rotId);
            saveState();
            playSfx('delete');
        }

        function toggleCooked(rotId) {
            const item = state.rotation.find(i => i.rotId === rotId);
            if (item) {
                item.cooked = !item.cooked;
                saveState();
                playSfx('scratch');
            }
        }

        // --- Render ---

        function renderCategoryButtons() {
            const container = document.getElementById('category-selector');
            container.innerHTML = CATEGORIES.map(cat => `
                <button onclick="setCategory('${cat}')" 
                    class="px-3 py-1 border-2 border-black text-sm uppercase ${selectedCategory === cat ? 'bg-indigo-500 text-white' : 'bg-white text-gray-700'}">
                    ${cat}
                </button>
            `).join('');
        }

        function renderAll() {
            renderRotation();
            renderRepository();
            lucide.createIcons();
        }

        function renderRotation() {
            const container = document.getElementById('rotation-list');
            if (state.rotation.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-10 text-xl"><p>Add meals and snacks to your repository and put them in your current list.</p></div>`;
                return;
            }

            let html = '';
            CATEGORIES.forEach(cat => {
                const items = state.rotation.filter(i => i.category === cat);
                if (items.length > 0) {
                    html += `<div class="cat-header">${cat}</div>`;
                    items.forEach(item => {
                        // Safe check for function existance in case data.js didn't load
                        const iconUrl = (typeof getIconUrl === 'function') 
                            ? getIconUrl(item.category, item.iconIndex || 0)
                            : '';

                        html += `
                        <div class="flex items-center bg-white border-2 border-black p-2 mb-2 shadow-sm ${item.cooked ? 'item-cooked' : ''}">
                            
                            <button onclick="toggleCooked('${item.rotId}')" class="mr-2 p-1 hover:bg-green-100 rounded">
                                ${item.cooked 
                                    ? `<i data-lucide="check-square" class="w-6 h-6 text-green-600"></i>` 
                                    : `<i data-lucide="square" class="w-6 h-6 text-gray-400"></i>`}
                            </button>

                            <div class="w-10 h-10 mr-3 flex-shrink-0 flex items-center justify-center">
                                <img src="${iconUrl}" class="w-8 h-8">
                            </div>

                            <span class="flex-1 text-2xl pt-1 truncate leading-none">${item.name}</span>

                            <button onclick="removeFromRotation('${item.rotId}')" class="text-red-400 hover:text-red-600 ml-2">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        `;
                    });
                }
            });
            container.innerHTML = html;
        }

        function renderRepository() {
            const container = document.getElementById('repo-list');
            let html = '';

            CATEGORIES.forEach(cat => {
                const items = state.repository.filter(i => i.category === cat);
                if (items.length > 0) {
                    html += `<div class="cat-header">${cat}</div>`;
                    items.forEach(item => {
                        const iconUrl = (typeof getIconUrl === 'function') 
                            ? getIconUrl(item.category, item.iconIndex || 0)
                            : '';

                        html += `
                        <div class="flex items-center bg-white border-2 border-black p-2 mb-2 shadow-sm group">
                            
                            <div class="w-10 h-10 border-2 border-gray-300 mr-3 flex-shrink-0 bg-gray-50 flex items-center justify-center overflow-hidden">
                                <img src="${iconUrl}" class="w-8 h-8">
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="text-xl leading-none pt-1 truncate">${item.name}</div>
                            </div>

                            <div class="flex gap-1 ml-2">
                                <button onclick="addToRotation('${item.id}')" class="btn-pixel bg-green-100 p-1 border border-black hover:bg-green-200">
                                    <i data-lucide="plus" class="w-4 h-4 text-green-700"></i>
                                </button>
                                <button onclick="editRepositoryItem('${item.id}')" class="btn-pixel bg-yellow-100 p-1 border border-black hover:bg-yellow-200">
                                    <i data-lucide="edit-2" class="w-4 h-4 text-yellow-700"></i>
                                </button>
                                <button onclick="deleteFromRepository('${item.id}')" class="btn-pixel bg-red-100 p-1 border border-black hover:bg-red-200">
                                    <i data-lucide="trash-2" class="w-4 h-4 text-red-700"></i>
                                </button>
                            </div>
                        </div>
                        `;
                    });
                }
            });

            if(html === '') {
                 container.innerHTML = `<div class="text-center text-gray-500 mt-4"><p>Repo is empty.</p></div>`;
            } else {
                container.innerHTML = html;
            }
        }
    </script>
</body>
</html>
